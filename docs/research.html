<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Research – Georgios Manalis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>
h3 {
color: #A0522D;
}
</style>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Georgios Manalis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./research.html" aria-current="page"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./policywork.html"> 
<span class="menu-text">Policy work</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#working-papers" id="toc-working-papers" class="nav-link active" data-scroll-target="#working-papers">Working papers</a>
  <ul class="collapse">
  <li><a href="#the-mystery-of-land-rights-explorations-on-informal-institutions-in-ghana" id="toc-the-mystery-of-land-rights-explorations-on-informal-institutions-in-ghana" class="nav-link" data-scroll-target="#the-mystery-of-land-rights-explorations-on-informal-institutions-in-ghana">The Mystery of Land Rights: Explorations on Informal Institutions in Ghana</a></li>
  <li><a href="#land-rights-and-risk-sharing-in-rural-west-africa" id="toc-land-rights-and-risk-sharing-in-rural-west-africa" class="nav-link" data-scroll-target="#land-rights-and-risk-sharing-in-rural-west-africa">Land rights and risk-sharing in rural West Africa</a></li>
  <li><a href="#contagion-as-a-dealmaker-the-effect-of-financial-spillovers-on-regional-lending-programs" id="toc-contagion-as-a-dealmaker-the-effect-of-financial-spillovers-on-regional-lending-programs" class="nav-link" data-scroll-target="#contagion-as-a-dealmaker-the-effect-of-financial-spillovers-on-regional-lending-programs">Contagion as a dealmaker? The effect of financial spillovers on regional lending programs</a></li>
  </ul></li>
  <li><a href="#work-in-progress" id="toc-work-in-progress" class="nav-link" data-scroll-target="#work-in-progress">Work in progress</a>
  <ul class="collapse">
  <li><a href="#local-trade-and-mutual-insurance" id="toc-local-trade-and-mutual-insurance" class="nav-link" data-scroll-target="#local-trade-and-mutual-insurance">Local trade and mutual insurance</a></li>
  </ul></li>
  <li><a href="#publications" id="toc-publications" class="nav-link" data-scroll-target="#publications">Publications</a>
  <ul class="collapse">
  <li><a href="#trust-dynamics-in-electoral-competition" id="toc-trust-dynamics-in-electoral-competition" class="nav-link" data-scroll-target="#trust-dynamics-in-electoral-competition">Trust dynamics in electoral competition</a></li>
  <li><a href="#bandwagons-in-costly-elections-the-role-of-loss-aversion" id="toc-bandwagons-in-costly-elections-the-role-of-loss-aversion" class="nav-link" data-scroll-target="#bandwagons-in-costly-elections-the-role-of-loss-aversion">Bandwagons in costly elections: the role of loss aversion</a></li>
  </ul></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Research</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="working-papers" class="level2">
<h2 class="anchored" data-anchor-id="working-papers">Working papers</h2>
<section id="the-mystery-of-land-rights-explorations-on-informal-institutions-in-ghana" class="level3">
<h3 class="anchored" data-anchor-id="the-mystery-of-land-rights-explorations-on-informal-institutions-in-ghana">The Mystery of Land Rights: Explorations on Informal Institutions in Ghana</h3>
<p>(with <a href="https://sites.google.com/site/mazurecon/home">K. Mazur</a>)</p>
<p>[<a href="https://drive.google.com/file/d/1AKQbuWAvM1hBsS6STqLIpKXYt7fiKtA-/view?usp=sharing">Link to working paper</a>] - in preparation for the Carnegie-Rochester-NYU Conference Series on Public Policy - preliminary, comments welcome)</p>
<p>(previously circulated as ‘Mutual insurance and land security in rural Ghana’)</p>
<p>We investigate why informal institutions persist despite policy efforts to introduce formal alternatives. Using Ghana’s nationwide rollout of land registration offices, we show that increased access to formal land institutions does not significantly raise land rights adoption. Instead, we show that local traditional authorities—village chiefs—actively constrain the formalization of agricultural land markets. We develop a structural model of endogenous take-up of land rights, integrating their effects on land markets and informal risk-sharing. While the estimated welfare cost of chiefs’ power inhibiting the take-up of land rights is large, the model also reveals a critical trade-off: although enhanced formal land rights typically improve insurance and reduce misallocation, excessive formalization risks collapsing informal insurance networks. Thus, rural communities may rationally retain informal institutions to preserve their immediate benefits.</p>
<p><strong>Presented</strong>: Departmental seminar - University of Cyprus (2020); STEG - CEPR annual conference (2021); Departmental seminar - University of Macedonia (2021); Asian Meeting of the Econometric Society in China (2022); SIOE - Toronto (2022); EEA - ESEM, Milan (2022); RES - SES, Glasgow (2023); AFES, Nairobi (2023); SED, Cartagena (2023); AFES, Abidjan (2024).</p>
</section>
<section id="land-rights-and-risk-sharing-in-rural-west-africa" class="level3">
<h3 class="anchored" data-anchor-id="land-rights-and-risk-sharing-in-rural-west-africa">Land rights and risk-sharing in rural West Africa</h3>
<p>(revised draft coming soon)</p>
<p>Despite arduous efforts of advancing land rights in Africa, most of the continent experiences low levels of ownership security. Land reforms introduced by the state have failed to deliver the desired results of officially recognized property. I propose a novel contextualization of land rights that motivates a theoretical model to account for land reforms’ effects when implemented in weak institutional environments with high risk. In environments such as rural Africa, communities have developed informal mechanisms of risk-sharing to provide households with a safety net. Therefore, when a land reform, aiming at granting individual property rights, takes place, it operates in a highly antagonistic way to the established informal insurance mechanisms. I use survey data from a land reform initiated in Burkina Faso in 2009 to evince the interaction between land holdings and transfers among community members. Subsequently, I build a model of risk-sharing with limited commitment to explain the competing forces developed between statutory land reforms and customary risk-sharing networks at a community level. The model shows that a land reform increases the share of surplus that a villager can extract from a risk-sharing contract among community members and decreases the size of the pie available to the community. Additionally, it shows a non-monotonic relation between land allocation and productivity pointing towards a trade-off between output efficiency and size of risk-sharing. It accurately accounts for the low participation rates from rural population to the Burkina Faso land reform and it provides a reasoning for potential land misallocation.</p>
<p><strong>Presented</strong>: Giorgio Rota Conference 2019 (University of Turin); Belgrade Young Economists Conference (BYEC 2019); Warsaw International Economic Meeting (WIEM 2019); ASSET 2019 Conference; IEWG (EUI); EERN 2020 Conference (University of Orléans); GLAD 2020 Conference (University of Göttingen); Conference on Research on Economic Theory and Econometrics - CRETE 2021.</p>
<p><strong>Awarded</strong>: 7th Giorgio Rota Best Paper Award; Best paper at Warsaw International Economic Meeting 2019; Shortlisted for LAGV Prize (ASSET 2019).</p>
</section>
<section id="contagion-as-a-dealmaker-the-effect-of-financial-spillovers-on-regional-lending-programs" class="level3">
<h3 class="anchored" data-anchor-id="contagion-as-a-dealmaker-the-effect-of-financial-spillovers-on-regional-lending-programs">Contagion as a dealmaker? The effect of financial spillovers on regional lending programs</h3>
<p>(with A. I. Bonk and <a href="https://sites.google.com/site/alexandrafotiou/home">A. Fotiou</a>) - [IMF Working Papers, Vol 2022: Issue 133 ]</p>
<p>The recent European sovereign debt crisis highlighted the critical role of regional lending arrangements. For the first time, European mechanisms were called to design financing programs for member countries in trouble. This paper analyses how the risk of contagion, an essential characteristic of interlinked economies, shapes borrowing conditions. We focus on the role of spillovers as a channel of bargaining power that a country might have when asking for financial support from regional lending institutions. We build and present a new database that records both the dates on which official meetings took place, relevant statements were released and the timing of the announcements regarding loan disbursements. This database allows us to assess the defining role that announcements of future actions have in mitigating spillover costs. In addition, we study the design of lending arrangements within a recursive contract between a lender and a sovereign country. When accounting for spillover costs, arising from the borrower to the creditor, we find that it is in the lender’s best interest to back-load consumption by giving more weight to future transfers in order to reduce contagion cost. Subsequently, we test and validate our theoretical predictions by assessing the effect of spillovers on loan disbursements to program-countries and by juxtaposing lending conditions imposed by the IMF and the European mechanisms.</p>
<p><strong>Presented</strong>: Conference on Research on Economic Theory and Econometrics - CRETE 2019.</p>
</section>
</section>
<section id="work-in-progress" class="level2">
<h2 class="anchored" data-anchor-id="work-in-progress">Work in progress</h2>
<section id="local-trade-and-mutual-insurance" class="level3">
<h3 class="anchored" data-anchor-id="local-trade-and-mutual-insurance">Local trade and mutual insurance</h3>
<p>Opening to trade may pose challenges for small, open economies with weak risk-insurance mechanisms. Trade liberalization often leads to specialization in the production structure, a key outcome of classical trade theory. This specialization exposes economies to external fluctuations, resulting in increased earnings volatility. Consequently, economies with incomplete insurance markets potentially experience reduced welfare. This issue is particularly prominent in the context of small rural village economies in the developing world due to two primary factors: (i) the absence of formal risk-insurance mechanisms and (ii) the inherent volatility of agricultural output. In response to these challenges, rural village economies have developed informal practices of mutual insurance, such as gift-giving and production sharing, to achieve a degree of consumption smoothing. This project aims to quantitatively assess the interaction between the allocative effects of opening to trade with the distributional effects of informal mutual insurance mechanisms for rural populations in low-income countries engaged in local trade.</p>
<p><strong>Presented</strong>: SES, Glasgow (2024); AFES, Abidjan (2024).</p>
</section>
</section>
<section id="publications" class="level2">
<h2 class="anchored" data-anchor-id="publications">Publications</h2>
<section id="trust-dynamics-in-electoral-competition" class="level3">
<h3 class="anchored" data-anchor-id="trust-dynamics-in-electoral-competition">Trust dynamics in electoral competition</h3>
<p>(with <a href="https://sites.google.com/view/nektaria-glynia/home">N. Glynia</a> and <a href="https://sites.google.com/site/dxefteris/">D. Xefteris</a>) - forthcoming in European Economic Review</p>
<p>[<a href="https://www.sciencedirect.com/science/article/pii/S0014292125001758?dgcid=author">Link to journal article</a>], [<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4794513">Working paper version</a>], [<a href="https://github.com/GManalis/Trust_Dynamics_in_Electoral_Competition.git">Replication code</a>]</p>
<p>We study the fragility of trust between voters and politicians, exploring the likelihood of trust recovery following disruptions. We identify a critical trust threshold: above it, the trust dynamics converge to a stable steady state marked by politicians’ moderate deception and voters’ tempered expectations; below it, trust gradually declines, giving way to deepening scepticism. These insights highlight that while stable levels of trust are feasible, they should not be taken for granted, contributing to the discussion on the underpinnings of recent trust crises across European democracies.</p>
</section>
<section id="bandwagons-in-costly-elections-the-role-of-loss-aversion" class="level3">
<h3 class="anchored" data-anchor-id="bandwagons-in-costly-elections-the-role-of-loss-aversion">Bandwagons in costly elections: the role of loss aversion</h3>
<p>(with <a href="https://sites.google.com/view/anastasialeontiou">A. Leontiou</a> and <a href="https://sites.google.com/site/dxefteris/">D. Xefteris</a>) - 2023 in Journal of Economic Behavior &amp; Organization</p>
<p>[<a href="https://www.sciencedirect.com/science/article/pii/S016726812300077X?via%3Dihub">Link to journal article</a>], [<a href="https://github.com/GManalis/Bandwagons_in_Costly_Elections.git">Replication code</a>]</p>
<p>The formal study of voluntary elections with costly participation predicts that the supporters of the underdog - i.e., of the candidate that is expected to lose - are less likely to abstain than the supporters of the expected winner (Palfrey and Rosenthal, 1985; Herrera et al., 2014). While some empirical/experimental studies identify this underdog effect (Levine and Palfrey, 2007), in others bandwagons emerge: the supporters of the expected winner are found to abstain less often than the supporters of the underdog (Agranov et al., 2018). We focus on large elections and follow Köszegi and Rabin (2006) by considering that voters experience gains and losses with respect to their expected equilibrium payoffs. When the election is sufficiently close (i.e., when the shares of the supporters of the two alternatives are not too asymmetric), we find that bandwagons emerge in every equilibrium. To our knowledge, this is the first formal study that explains bandwagons in large elections, by incorporating a commonly accepted behavioural model in an otherwise standard context of costly voting.</p>
</section>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>